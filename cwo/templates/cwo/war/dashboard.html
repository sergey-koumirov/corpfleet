{% extends 'base.html' %}
{% load staticfiles %}

{% block content %}

<script>
var toogleSystemNames = function(tid){
    var checked = $('#showtext'+tid).prop('checked');
    $('#t'+tid+' text').toggle(checked);
}

var pointsHash = {}
var getOrCalc = function(adm){
  if( !pointsHash[adm] ){
      var r1 = 4.0,
          r2 = 4.0 + 2.0 + adm * 1.5,
          desc = "";
      points=[
        {x: 0, y: r1},
        {x: r1 * Math.cos( Math.PI/6 ), y: r1 * Math.sin( Math.PI/6 )},
        {x: r2 * Math.cos( Math.PI/6 ), y: r2 * Math.sin( Math.PI/6 )},
        {x: 0, y: r2},
        {x: r2 * Math.cos( 5*Math.PI/6 ), y: r2 * Math.sin( 5*Math.PI/6 )},
        {x: r1 * Math.cos( 5*Math.PI/6 ), y: r1 * Math.sin( 5*Math.PI/6 )}
      ]

      $.each(points, function(i,el){
        if(i==0){
          desc = "M "+el.x+" "+el.y+" ";
        }else{
          desc = desc + "L "+el.x+" "+el.y+" ";
        }
      });
      pointsHash[adm] = desc;
  }
  return pointsHash[adm];
}

var getOwnerOnDate = function(owners, date){
  for(index in owners){
      var own = owners[index]
      if(own.d1 < date && date <= own.d2){
         return own;
      }
  }
  return null;
}

var participants = {
{% for aid, participants in map.participants.items %}
  {{aid}}: [
    {% for participant in participants %}
    { pid:{{participant.pid}}, name:'{{participant.name}}', d1:'{{participant.d1 | date:'Y-m-d H:i:s'}}', d2:'{{participant.d2 | date:'Y-m-d H:i:s'}}', color: '{{participant.color}}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]{% if not forloop.last %},{% endif %}
{% endfor %}
}

var getParticipant = function(aid, date){
  values = participants[aid]
  if(values){
      for(index in values){
          var p = values[index]
          if(p.d1 < date && date <= p.d2){
             return p;
          }
      }
  }
  return null;
}

var ownership = {
{% for sid, owns in map.ownership.items %}
'{{sid}}': [
  {% for own in owns %}{m:{{own.m}},aid:{{own.aid}},d1:'{{own.d1 | date:'Y-m-d H:i:s'}}',d2:'{{own.d2 | date:'Y-m-d H:i:s'}}'}{% if not forloop.last %},{% endif %}{% endfor %}
]{% if not forloop.last %},{% endif %}
{% endfor %}
};


var setStyle = function(el, desc, fill, opacity, stroke, dasharray){
    el.attr('d', desc );
    el.attr('fill', fill);
    el.attr('fill-opacity', opacity);
    el.attr('stroke', stroke);
    el.attr('stroke-opacity', opacity + (1.0 - opacity)/3.0 );
    if(dasharray){
        el.attr('stroke-dasharray', dasharray);
    }
}

var showOwnership = function(){
  var sDate = $('#date').val();
  for(k in ownership){
      var values = ownership[k],
          owner = getOwnerOnDate(values,sDate),
          el = $("."+k);

      if(owner == null){
          el.attr('d', '' );
      }else{
          var participant = getParticipant(owner.aid, sDate),
              desc = getOrCalc(owner.m);
          if(participant){
              setStyle(el, desc, participant.color, 0.5, participant.color)
          }else{
              setStyle(el, desc, "url(#diagonalHatch)", 0.5, '#808080')
          }
      }
  }
}

var showDiffOwnership = function(){
    var sDate1 = $('#date1').val(),
        sDate2 = $('#date2').val();
    for(k in ownership){
        var values = ownership[k],
            owner1 = getOwnerOnDate(values,sDate1),
            owner2 = getOwnerOnDate(values,sDate2),
            el = $("."+k),
            participant1 = null,
            participant2 = null;

        if(owner1 != null ){ participant1 = getParticipant(owner1.aid, sDate1); }
        if(owner2 != null ){ participant2 = getParticipant(owner2.aid, sDate2); }

        if(owner1 != null && owner2 == null){
            var desc = getOrCalc(owner1.m);
            if(participant1==null){
                setStyle(el, desc, "url(#tilePatternX)", 0.5, '#808080', '2 2');
            }else{
                setStyle(el, desc, "url(#tilePattern"+participant1.pid+")", 0.5, participant1.color, '2 2');
            }
        }else if(
            owner1 == null && owner2 != null ||
            (
                owner1 != null && owner2 != null && (
                    participant1==null && participant2!=null ||
                    participant1!=null && participant2==null ||
                    participant1!=null && participant2!=null && participant1.pid != participant2.pid
                )
            )
        ){
            var desc = getOrCalc(owner2.m);
            if(participant2==null){
                setStyle(el, desc, "#808080", 0.5, '#808080');
            }else{
                setStyle(el, desc, participant2.color, 0.5, participant2.color);
            }
        }else{
            el.attr('d', '' );
        }

    };
}

$(function(){
  var date = new Date()
      date1 = new Date(date);

  date1.setDate(date1.getDate() - 7);

  $('#date').val(date.toISOString().split('T').join(' ').split('.')[0]);

  $('#date1').val(date1.toISOString().split('T').join(' ').split('.')[0]);

  $('#date2').val(date.toISOString().split('T').join(' ').split('.')[0]);

  showOwnership();
});

</script>

<h4><a href="{% url 'cwo:war_index' %}">Wars</a> / {{ map.war.name }} / Powers & Maps</h4>

<div class="row">
    <div class="col-md-3">
        <form-group>
            <label for="date">On date</label>
            <input id="date" type="text">
            <button class="btn btn-default" onclick="showOwnership()"> &gt;&gt;&gt; </button>
        </form-group>
    </div>
    <div class="col-md-6">
        <form-group>
            <label for="date">Date Diff</label>
            <input id="date1" type="text">
            <input id="date2" type="text">
            <button class="btn btn-default" onclick="showDiffOwnership()"> &gt;&gt;&gt; </button>
        </form-group>
    </div>
</div>


<h3>Participants</h3>
    {% for participant in map.war.participant_set.all %}
    <ul class="participant">
        <li style="color:{{participant.color}}"><b>{{participant.name}}</b></li>
        <ul>
            {% for alliance in participant.info.alliances %}
            <li>
                <span style="color:{{participant.color}}">{{alliance.alliance_name}}</span>
                {% ifnotequal alliance.date2 '9999-12-31 23:59:59' %}
                    {{alliance.date2}}
                {% endifnotequal %}
            </li>
            {% endfor %}
        </ul>
    </ul>
    {% endfor %}

<hr class="clear">

<h3>Territories</h3>

{% for tid, tinfo in map.war_systems.items %}
<h4>{{tinfo.territory.name}} </h4>
<label for="showtext{{tid}}">Show system names</label><input id="showtext{{tid}}" type="checkbox" autocomplete="off" checked="checked" onclick="toogleSystemNames({{tid}})"/>
<br>
{% for region in tinfo.territory.regions %}
<span class="btn-my">{{region.name}}</span>
{% endfor %}
<br>
<svg id="t{{tid}}" viewBox="-50 -50 1100 1100" width="1350" height="1350" style="border: 1px solid #404040">
    {% for link in tinfo.links %}
    <line x1="{{link.from.sx|floatformat}}" y1="{{link.from.sz|floatformat}}" x2="{{link.to.sx|floatformat}}" y2="{{link.to.sz|floatformat}}" />
    {% endfor %}

    {% for sid, system in tinfo.systems.items %}
    <circle cx="{{system.sx|floatformat}}" cy="{{system.sz|floatformat}}" r="2" />
    <path class="s{{sid}}h" transform="translate({{system.sx|floatformat}},{{system.sz|floatformat}}) rotate(60, 0, 0)"/>
    <path class="s{{sid}}t" transform="translate({{system.sx|floatformat}},{{system.sz|floatformat}}) rotate(180, 0, 0)"/>
    <path class="s{{sid}}s" transform="translate({{system.sx|floatformat}},{{system.sz|floatformat}}) rotate(300, 0, 0)"/>
    {% endfor %}

    {% for sid, system in tinfo.systems.items %}
    <text x="{{system.sx|floatformat}}" dx="10" y="{{system.sz|floatformat}}" dy="4">{{system.name}}</text>
    {% endfor %}
</svg>

{% endfor %}
<svg>
    <defs>
        <pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
            <path d="M-1,1 l2,-2  M0,4 l4,-4  M3,5 l2,-2" style="stroke:#CCCCCC; stroke-width:1"/>
        </pattern>

        {% for participant in map.war.participant_set.all %}
        <rect id="tileRect{{participant.id}}" x="0.5" y="0.5" width="3.0" height="3.0" fill="{{participant.color}}"/>
        <pattern id                    = "tilePattern{{participant.id}}"
                 x                     = "0"
                 y                     = "0"
                 width                 = "4"
                 height                = "4"
                 patternContentUnits   = "userSpaceOnUse"
                 patternUnits          = "userSpaceOnUse">
            <use xlink:href="#tileRect{{participant.id}}" />
        </pattern>
        {% endfor %}

        <rect id="tileRectX" x="0.5" y="0.5" width="2.0" height="2.0" fill="#808080"/>
        <pattern id                    = "tilePatternX"
                 x                     = "0"
                 y                     = "0"
                 width                 = "4"
                 height                = "4"
                 patternContentUnits   = "userSpaceOnUse"
                 patternUnits          = "userSpaceOnUse">
            <use xlink:href="#tileRectX" />
        </pattern>

    </defs>
</svg>
{% endblock %}